<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>산업군 상세 - Tulipmetric</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    h1 { font-size: 1.5rem; font-weight: 500; line-height: 1.5; }
    h2 { font-size: 1.25rem; font-weight: 500; line-height: 1.5; }
    h3 { font-size: 1.125rem; font-weight: 500; line-height: 1.5; }
    h4 { font-size: 1rem; font-weight: 500; line-height: 1.5; }
    label, button { font-size: 1rem; font-weight: 500; line-height: 1.5; }
    input { font-size: 1rem; font-weight: 400; line-height: 1.5; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
<!-- Header -->
<div th:replace="~{fragments/basicheader :: basicheader-fragment}"></div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Back Button -->
    <div class="mb-6">
      <a href="/" class="inline-flex items-center gap-2 text-slate-600 hover:text-slate-900 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        전체 산업군으로 돌아가기
      </a>
    </div>

    <!-- Industry Header -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 mb-8">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-3">
            <h1 id="industryName" class="text-slate-900 text-3xl" th:text="${market.name}">산업군명</h1>
            <span id="trendingBadge" class="px-3 py-1 bg-gradient-to-r from-orange-500 to-pink-500 text-white text-sm rounded-full animate-pulse" style="display: none;">
              급상승
            </span>
          </div>
          <p id="industryDescription" class="text-slate-600 mb-6" th:text="|${market.name} 산업군 상세정보|">산업군 상세정보</p>
          
          <!-- Key Metrics Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Monthly Growth Card -->
            <div class="group relative bg-gradient-to-br from-blue-50 to-white rounded-xl p-5 border-2 border-slate-200 hover:border-blue-400 transition-all duration-300 hover:shadow-lg overflow-hidden">
              <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-400/20 to-transparent rounded-bl-full"></div>
              <div class="relative">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-slate-500 uppercase tracking-wide">한달간 주가 상승률</span>
                  <svg id="monthlyGrowthIcon" class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                  </svg>
                </div>
                <div
                        class="text-2xl"
                        style="font-weight:600;"
                        th:classappend="${market.growthRate30d == null ? ' text-slate-500'
                   : (market.growthRate30d < 0 ? ' text-red-600' : ' text-green-600')}"
                        th:text="${market.growthRate30d == null ? '-'
           : (#numbers.formatDecimal(market.growthRate30d, 1, 2) + '%')}">
                  -
                </div>
              </div>
            </div>

            <!-- Total Market Cap Card -->
            <div class="group relative bg-gradient-to-br from-purple-50 to-white rounded-xl p-5 border-2 border-slate-200 hover:border-purple-400 transition-all duration-300 hover:shadow-lg overflow-hidden">
              <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-purple-400/20 to-transparent rounded-bl-full"></div>
              <div class="relative">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-slate-500 uppercase tracking-wide">산업군 시가총액</span>
                  <svg class="w-5 h-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div id="totalMarketCap" class="text-2xl text-purple-600" style="font-weight: 600;" th:text="${market.totalmarketcap}">0</div>
              </div>
            </div>

            <!-- Stock Count Card -->
            <div class="group relative bg-gradient-to-br from-orange-50 to-white rounded-xl p-5 border-2 border-slate-200 hover:border-orange-400 transition-all duration-300 hover:shadow-lg overflow-hidden">
              <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-orange-400/20 to-transparent rounded-bl-full"></div>
              <div class="relative">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-slate-500 uppercase tracking-wide">종목수</span>
                  <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                  </svg>
                </div>
                <div id="stockCount" class="text-2xl text-orange-600" style="font-weight: 600;" th:text="${market.stockcount}" data-format="int">0</div>
              </div>
            </div>

            <!-- Average PER Card -->
            <div class="group relative bg-gradient-to-br from-green-50 to-white rounded-xl p-5 border-2 border-slate-200 hover:border-green-400 transition-all duration-300 hover:shadow-lg overflow-hidden">
              <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-green-400/20 to-transparent rounded-bl-full"></div>
              <div class="relative">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-slate-500 uppercase tracking-wide">평균 PER</span>
                  <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                  </svg>
                </div>
                <div id="averagePer" class="text-2xl text-green-600" style="font-weight: 600;" th:text="${market.marketper}" data-format="decimal2">0</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex flex-col items-center gap-4 ml-8">
          <div id="tulipIcon" class="flex items-center justify-center"></div>
          <button type="button" id="favoriteBtn" data-fav="false" class="flex items-center gap-2 px-6 py-3 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
            <svg id="favoriteStar" class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <span id="favoriteText">즐겨찾기 추가</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Growth Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
      <h3 class="text-slate-900 mb-4">산업군 지수 추이 (최근 1년)</h3>
      <div id="chartContainer" class="h-64 overflow-x-auto"></div>
    </div>

    <!-- Companies Table -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <h3 class="text-slate-900 mb-6">기업 순위</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-slate-200">
              <th class="text-left py-3 px-4 text-slate-700" style="font-weight: 600;">순위</th>
              <th class="text-left py-3 px-4 text-slate-700" style="font-weight: 600;">기업명</th>
              <th class="text-right py-3 px-4 text-slate-700" style="font-weight: 600;">현재주가</th>
              <th class="text-right py-3 px-4 text-slate-700" style="font-weight: 600;">등락(원)</th>
              <th class="text-right py-3 px-4 text-slate-700" style="font-weight: 600;">등락률</th>
              <th class="text-right py-3 px-4 text-slate-700" style="font-weight: 600;">거래량</th>
              <th class="text-right py-3 px-4 text-slate-700" style="font-weight: 600;">시가총액</th>
            </tr>
          </thead>
          <tbody id="companiesTable">
                <tr th:if="${company == null or #lists.isEmpty(company)}">
                  <td colspan="7" class="py-8 text-center text-gray-500">기업 데이터가 없습니다.</td>
                </tr>

                <tr th:each="c, stat : ${company}" class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                  <td class="py-4 px-4 font-medium text-gray-900" th:text="${stat.count}">1</td>
                  <td class="py-4 px-4">
                    <div class="flex items-center">
                      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-100 to-purple-50 flex items-center justify-center mr-3">
                        <span class="text-purple-600 font-semibold" th:text="${#strings.isEmpty(c.itmsnm) ? '?' : #strings.substring(c.itmsnm,0,1)}">A</span>
                      </div>
                      <div>
                        <div class="font-medium text-gray-900" th:text="${c.itmsnm}">기업명</div>
                        <div class="text-sm text-gray-500" th:text="${c.market}">산업군</div>
                      </div>
                    </div>
                  </td>
                  <td class="py-4 px-4 text-right font-medium" data-format-cell="currency" th:text="${c.clpr}">0</td>
                  <td class="py-4 px-4 text-right" data-format-cell="signed_won" th:text="${c.vs}">0</td>
                  <td class="py-4 px-4 text-right" data-format-cell="signed_percent" th:text="${c.fltrt}">0</td>
                  <td class="py-4 px-4 text-right" data-format-cell="int" th:text="${c.trqu}">0</td>
                  <td class="py-4 px-4 text-right font-medium" data-format-cell="marketcap" th:text="${c.mrkttotamt}">0</td>
                </tr>
</tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/js/tulip.js"></script>

  <script th:inline="javascript">
      /*<![CDATA[*/
      window.marketChart = /*[[${market.chart}]]*/ [];
      /*]]>*/
    </script>

    <!-- index 페이지에서 쓰던 formatNumber() 재사용 (없으면 아래 fallback 사용) -->
    <script src="/js/index-ssr.js" defer></script>
    <script th:inline="javascript">
      window.marketGrowthRate30d = /*[[${market.growthRate30d}]]*/ null;
    </script>

    <script>
    (function () {
      // ---- formatNumber fallback ----
      if (typeof window.formatNumber !== 'function') {
        window.formatNumber = function (num, type) {
          if (num === null || num === undefined || num === '') return '-';
          const n = Number(num);
          if (!Number.isFinite(n)) return String(num);

          switch (type) {
            case 'currency':
              return '₩' + Math.round(n).toLocaleString();
            case 'marketCap':
              if (n >= 1e12) return (n / 1e12).toFixed(1) + '조';
              if (n >= 1e8) return (n / 1e8).toFixed(0) + '억';
              return '₩' + Math.round(n).toLocaleString();
            case 'volume':
              return Math.round(n).toLocaleString();
            case 'per':
              return (Math.round(n * 100) / 100).toFixed(2);
            default:
              return Math.round(n).toLocaleString();
          }
        };
      }

      function setTrendColor(el, value) {
        const target = el.closest('td') || el;
        target.classList.remove('text-rose-600', 'text-blue-600', 'text-gray-700');
        if (value > 0) target.classList.add('text-rose-600');
        else if (value < 0) target.classList.add('text-blue-600');
        else target.classList.add('text-gray-700');
      }

      // ---- 상단 카드 포맷 ----
      const totalMarketCapEl = document.getElementById('totalMarketCap');
      if (totalMarketCapEl) {
        totalMarketCapEl.textContent = formatNumber(totalMarketCapEl.textContent.trim(), 'marketCap');
      }

      const stockCountEl = document.getElementById('stockCount');
      if (stockCountEl) {
        stockCountEl.textContent = formatNumber(stockCountEl.textContent.trim(), 'volume') + '개';
      }

      const averagePerEl = document.getElementById('averagePer');
      if (averagePerEl) {
        averagePerEl.textContent = formatNumber(averagePerEl.textContent.trim(), 'per') + '배';
      }

      // ---- 기업 테이블 포맷 ----
      document.querySelectorAll('[data-format-cell]').forEach((el) => {
        const kind = el.dataset.formatCell;
        const raw = el.textContent.trim();
        const n = Number(raw);

        if (kind === 'currency') {
          el.textContent = formatNumber(n, 'currency');
        } else if (kind === 'signed_won') {
          const sign = n > 0 ? '+' : '';
          el.textContent = sign + Math.round(n).toLocaleString() + '원';
          setTrendColor(el, n);
        } else if (kind === 'signed_percent') {
          const sign = n > 0 ? '+' : '';
          const pct = Number.isFinite(n) ? n : 0;
          el.textContent = sign + pct.toFixed(2) + '%';
          setTrendColor(el, pct);
        } else if (kind === 'int') {
          el.textContent = formatNumber(n, 'volume');
        } else if (kind === 'marketcap') {
          el.textContent = formatNumber(n, 'marketCap');
        }
      });

            function renderIndexChart(indexSeries) {
        const chartContainer = document.getElementById('chartContainer');
        if (!chartContainer) return;

        const values = (Array.isArray(indexSeries) ? indexSeries : [])
          .map(Number)
          .filter(Number.isFinite);

        if (values.length === 0) {
          chartContainer.innerHTML = '<div class="text-sm text-slate-500 p-4">차트 데이터가 없습니다.</div>';
          return;
        }

        // 데이터가 오래된 → 최신 순서라고 가정 (12개월 데이터면 12개월 전 ~ 1개월 전)
        const months = values.length === 12
          ? ['12개월 전','11개월 전','10개월 전','9개월 전','8개월 전','7개월 전','6개월 전','5개월 전','4개월 전','3개월 전','2개월 전','1개월 전']
          : Array.from({ length: values.length }, (_, i) => `${values.length - i}개월 전`);

        // 지수는 min~max 기준으로 스케일링
        const minV = Math.min(...values);
        const maxV = Math.max(...values);
        const range = (maxV - minV) || 1;

        chartContainer.innerHTML = `
          <div class="flex items-end justify-between h-full gap-2 px-4 min-w-max">
            ${values.map((v, i) => {
              const prev = i > 0 ? values[i - 1] : null;
              const delta = prev === null ? 0 : (v - prev);

              const barColor =
                prev === null ? 'bg-slate-400'
                : delta > 0 ? 'bg-green-500'
                : delta < 0 ? 'bg-red-500'
                : 'bg-slate-400';

              const textColor =
                prev === null ? 'text-slate-500'
                : delta > 0 ? 'text-green-600'
                : delta < 0 ? 'text-red-600'
                : 'text-slate-500';

              const heightPercent = ((v - minV) / range) * 75 + 5;

              return `
                <div class="flex-1 flex flex-col items-center justify-end h-full min-w-[60px]">
                  <div class="text-xs font-medium ${textColor} mb-1 whitespace-nowrap">
                    ${Math.round(v).toLocaleString()}
                  </div>
                  <div class="${barColor} w-full rounded-t" style="height: ${heightPercent}%; min-height: 4px;"></div>
                  <div class="text-xs text-slate-500 mt-2 whitespace-nowrap">
                    ${months[i] ?? ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      renderIndexChart(window.marketChart);      // ---- 즐겨찾기(UI 토글만) ---- TODO 로그인 안한 사용자는 로컬 스토리지에 보관해서 나중에도 즐겨찾기한거 볼 수 있도록 구현, 로그인하면 로컬스토리지 비우고 사용자 데이터에서 즐겨찾기 불러오기. 마이페이지에는 로컬 스토리지에서 저장된 산업군 뽑아씀.
      const favoriteBtn = document.getElementById('favoriteBtn');
      const favoriteStar = document.getElementById('favoriteStar');
      const favoriteText = document.getElementById('favoriteText');

      function setFavoriteUI(isFav) {
        if (!favoriteBtn || !favoriteStar || !favoriteText) return;

        favoriteBtn.dataset.fav = isFav ? 'true' : 'false';

        favoriteBtn.classList.toggle('border-amber-300', isFav);
        favoriteBtn.classList.toggle('bg-amber-50', isFav);
        favoriteBtn.classList.toggle('text-amber-700', isFav);

        favoriteBtn.classList.toggle('border-slate-300', !isFav);
        favoriteBtn.classList.toggle('bg-white', !isFav);
        favoriteBtn.classList.toggle('text-slate-700', !isFav);

        favoriteStar.setAttribute('fill', isFav ? 'currentColor' : 'none');
        favoriteStar.classList.toggle('text-amber-500', isFav);
        favoriteStar.classList.toggle('text-slate-400', !isFav);

        favoriteText.textContent = isFav ? '즐겨찾기 해제' : '즐겨찾기 추가';
      }

      // ✅ 현재 URL에서 id 추출 (?id=123 우선, 없으면 /.../123 같은 마지막 path 숫자 시도)
      function getIdFromCurrentUrl() {
        const url = new URL(window.location.href);
        const qsId = url.searchParams.get('id');
        if (qsId && /^\d+$/.test(qsId)) return qsId;

        const seg = url.pathname.split('/').filter(Boolean).pop();
        if (seg && /^\d+$/.test(seg)) return seg;

        return null;
      }

      async function postSaveWishMarket(id) {
        const body = new URLSearchParams();
        body.set('id', id);

        const res = await fetch('/savewishmarket', {
          method: 'POST',
          credentials: 'same-origin', // 세션/쿠키 필요하면 필수
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          },
          body: body.toString(),
        });

        const text = await res.text(); // 서버가 0/1 “문자”로 준다고 했으니 text로 받음
        return { ok: res.ok, code: Number(String(text).trim()) };
      }

      if (favoriteBtn) {
        setFavoriteUI(favoriteBtn.dataset.fav === 'true');

        favoriteBtn.addEventListener('click', async () => {
          const id = getIdFromCurrentUrl();
          if (!id) {
            alert('id 값을 URL에서 찾지 못했습니다.');
            return;
          }

          const before = (favoriteBtn.dataset.fav === 'true');

          // 중복 클릭 방지
          favoriteBtn.disabled = true;
          favoriteBtn.classList.add('opacity-60', 'cursor-not-allowed');

          try {
            const { ok, code } = await postSaveWishMarket(id);

            // 성공: 0, 실패: 1
            if (ok && code === 0) {
              setFavoriteUI(!before);
            } else {
              alert('즐겨찾기 저장에 실패했습니다.');
              setFavoriteUI(before);
            }
          } catch (e) {
            console.error(e);
            alert('네트워크 오류로 즐겨찾기 저장에 실패했습니다.');
            setFavoriteUI(before);
          } finally {
            favoriteBtn.disabled = false;
            favoriteBtn.classList.remove('opacity-60', 'cursor-not-allowed');
          }
        });
      }

      })();
    </script>
</body>
</html>